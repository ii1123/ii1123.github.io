<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lojain — A23</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css?v=3">

  <!-- تحسينات الموبايل + منع التداخل -->
  <style>
    :root { --vh: 1vh; }

    .wrap { min-height: 100svh; min-height: calc(var(--vh) * 100); padding: 16px; }
    .card { max-width: 92vw; margin: 0 auto; border-radius: 14px; }

    .cta, button, .down {
      display: inline-block;
      width: 100%;
      max-width: 520px;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 12px;
      touch-action: manipulation;
    }

    @media (max-width: 480px) {
      h1 { font-size: 28px; }
      .subtitle { font-size: 14px; line-height: 1.5; }
      .breath-steps { font-size: 13px; }
      .footer { font-size: 12px; }
      #sinceCounter { font-size: 13px; }
    }

    /* طبقات الخلفية ما تستقبل لمس */
    .stars, .hearts { pointer-events: none; }

    /* مسافة سفليّة كافية عشان المثبّتات ما تغطي المحتوى */
    .wrap, .section, .notebook { padding-bottom: 240px; }

    /* العداد ثابت يمين تحت */
    .since {
      position: fixed !important;
      right: 16px;
      left: auto !important;
      transform: none !important;
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      z-index: 7;
    }

    /* الدمية فوق العداد */
    .mood-toy {
      position: fixed;
      right: 16px;
      bottom: calc(96px + env(safe-area-inset-bottom, 0px));
      z-index: 8;
    }

    /* المذكرة بحجم مناسب ومتمركزة */
    .notebook {
      display: block !important;
      position: relative;
      z-index: 2;
      max-width: 720px;
      margin: 24px auto;
      padding: 12px;
    }
    #memo {
      width: 100%;
      box-sizing: border-box;
      min-height: 160px;
      resize: vertical;
    }

    #readyCard { position: relative; z-index: 2; }

    @media (max-width: 600px) {
      .card { max-width: 94vw; }
      .notebook { max-width: 94vw; margin: 20px auto; }
      .mood-toy { right: 12px; bottom: calc(96px + env(safe-area-inset-bottom, 0px)); }
      .since { right: 12px; bottom: calc(14px + env(safe-area-inset-bottom, 0px)); }
    }
  </style>
</head>

<body>
  <!-- خلفية متحركة -->
  <div class="stars" id="stars"></div>
  <div class="hearts" id="hearts"></div>

  <!-- الكارد الرئيسي -->
  <div class="wrap">
    <div class="card">
      <h1>Lojain ❤️</h1>
      <p class="subtitle">If you ever feel overwhelmed, open this page. I’m here — always. — A23</p>

      <div class="line" id="line"></div>
      <div class="dots" id="dots" aria-hidden="true"></div>

      <a class="cta" href="#" id="confettiBtn" title="Tap">A small touch of love</a>
      <a id="downLink" class="down" href="#readySection">↓ Scroll when you’re ready</a>

      <div class="support">
        <h3>Read this slowly whenever you need it</h3>
        <p>• You’re not alone. I’m with you — now and always.</p>
        <p>• Whatever happened, we’ll face it together. One step at a time.</p>
        <p>• You are loved, you are safe, and your feelings matter to me.</p>
        <p>• Text me when you’re ready. Or just read this and breathe — I’m here.</p>

        <div class="breathe">
          <div class="circle"><div class="circle-inner"></div></div>
          <div class="breath-steps">Inhale 4 • Hold 4 • Exhale 6 — repeat</div>
        </div>
      </div>

      <div class="footer">Made with care — A23</div>
    </div>
  </div>

  <!-- Section 2 -->
  <section class="section" id="readySection">
    <div class="card" id="readyCard">
      <h2 style="margin:0 0 10px 0">When you’re ready</h2>
      <p class="subtitle" style="text-align:left">
        Take a breath. When you feel okay, tap the button below.
      </p>

      <button id="readyOnceBtn" class="cta" style="margin-top:10px">I’m ready — tap once</button>
      <button id="resetReady" class="cta" style="margin-top:6px;">Reset (all devices)</button>
      <p id="readyOnceState" class="footer" style="margin-top:8px"></p>
    </div>
  </section>

  <!-- Notebook -->
  <div class="notebook">
    <div class="title">Memo</div>
    <textarea id="memo" placeholder="Write in the book…"></textarea>
    <button id="saveMemo">Save</button>
    <div class="memo-hint">Saved only on this device</div>
  </div>

  <!-- Since widget -->
  <div class="since"><strong id="sinceCounter">—</strong></div>

  <!-- Mood Toy (SVG, no images) -->
  <div class="mood-toy glass" id="moodToy" role="button" aria-pressed="false" title="Click to toggle mood">
    <div class="toy-label" id="toyLabel">Click me</div>
    <div class="toy-figure" id="toyFigure" aria-hidden="true">
      <svg viewBox="0 0 200 200" width="120" height="120" class="toy-svg" aria-hidden="true">
        <defs>
          <radialGradient id="happyGrad" cx="30%" cy="30%">
            <stop offset="0%"  stop-color="#d9dbe8"/>
            <stop offset="100%" stop-color="#9da3bb"/>
          </radialGradient>
          <radialGradient id="sadGrad" cx="30%" cy="30%">
            <stop offset="0%"  stop-color="#3a3a48"/>
            <stop offset="100%" stop-color="#0f0f17"/>
          </radialGradient>
          <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
            <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#000" flood-opacity=".35"/>
          </filter>
        </defs>

        <!-- جسم -->
        <circle id="head" cx="100" cy="90" r="58" filter="url(#softShadow)"/>

        <!-- وجه سعيد -->
        <g class="face face-happy">
          <circle cx="80" cy="85" r="6" fill="#222"/>
          <circle cx="120" cy="85" r="6" fill="#222"/>
          <path d="M75 105 Q100 122 125 105" fill="none" stroke="#222" stroke-width="5" stroke-linecap="round"/>
          <circle cx="65" cy="100" r="6" fill="#ff9dbd" opacity=".55"/>
          <circle cx="135" cy="100" r="6" fill="#ff9dbd" opacity=".55"/>
        </g>

        <!-- وجه زعلان -->
        <g class="face face-sad">
          <rect x="73" y="74" width="14" height="10" rx="2" fill="#e9e9ee"/>
          <rect x="113" y="74" width="14" height="10" rx="2" fill="#e9e9ee"/>
          <path d="M78 110 Q100 96 122 110" fill="none" stroke="#e9e9ee" stroke-width="5" stroke-linecap="round"/>
        </g>
      </svg>
    </div>
  </div>

  <!-- Scripts الأساسية -->
  <script>
    /* rotating lines */
    let lines=[
      "If anything feels heavy today, hand it to me — I’ll carry it with you.",
      "No matter what, you’re not facing this alone.",
      "I’m proud of you, even on the days you can’t see it.",
      "Take your time. I’ll wait. I’m not going anywhere.",
      "Your feelings are safe with me — always.",
      "You are loved more than any bad moment can measure.",
      "Breathe. One small step is enough for today.",
      "If you need me at 3AM or 3PM — I’m there.",
      "I choose you on the bright days and the stormy ones.",
      "You and I — team forever."
    ];
    let idx=0; const lineEl=document.getElementById('line'); const dotsEl=document.getElementById('dots');
    lines.forEach((_,i)=>{ const d=document.createElement('div'); d.className='dot'+(i===0?' active':''); dotsEl.appendChild(d); });
    function renderLine(t){ lineEl.innerHTML=''; const s=document.createElement('span'); s.textContent=t; lineEl.appendChild(s); }
    function setActiveDot(i){ Array.from(dotsEl.children).forEach((d,k)=>d.classList.toggle('active',k===i)); }
    function nextLine(){ renderLine(lines[idx]); setActiveDot(idx); idx=(idx+1)%lines.length; }
    nextLine(); setInterval(nextLine,2600);

    /* stars */
    const stars=document.getElementById('stars');
    for(let i=0;i<80;i++){
      const s=document.createElement('div');
      s.className='star';
      s.style.left=Math.random()*100+'vw';
      s.style.top=Math.random()*100+'vh';
      s.style.animationDelay=(Math.random()*6).toFixed(2)+'s';
      s.style.opacity=(0.3+Math.random()*0.7).toFixed(2);
      stars.appendChild(s);
    }

    /* hearts */
    const hearts=document.getElementById('hearts');
    function spawnHeart(){
      const h=document.createElement('div');
      h.className='heart';
      h.style.left=Math.random()*100+'vw';
      h.style.bottom='-20px';
      h.style.animationDuration=(8+Math.random()*5).toFixed(2)+'s';
      h.style.opacity=(0.5+Math.random()*0.5).toFixed(2);
      hearts.appendChild(h);
      setTimeout(()=>h.remove(),12000);
    }
    setInterval(spawnHeart,700);

    /* confetti */
    const btnConfetti=document.getElementById('confettiBtn');
    btnConfetti.addEventListener('click',(e)=>{ e.preventDefault(); for(let i=0;i<120;i++){ makeParticle(); } });
    function makeParticle(){
      const p=document.createElement('div');
      p.style.position='fixed';
      p.style.left=(window.innerWidth/2)+(Math.random()*60-30)+'px';
      p.style.top=(window.innerHeight/2)+(Math.random()*20-10)+'px';
      p.style.width='6px'; p.style.height='10px';
      p.style.background=['#ff4d6d','#ffd166','#06d6a0','#4cc9f0','#f72585'][Math.floor(Math.random()*5)];
      p.style.transform='rotate('+(Math.random()*360)+'deg)'; p.style.opacity='0.9'; p.style.zIndex='9999';
      document.body.appendChild(p);
      const dx=(Math.random()-0.5)*12, dy=(Math.random()-0.9)*14; let x=0,y=0,life=0;
      const t=setInterval(()=>{ life++; x+=dx; y+=dy+life*0.15; p.style.transform=`translate(${x}px,${y}px) rotate(${life*12}deg)`; p.style.opacity=String(0.9-life/90); if(life>90){ clearInterval(t); p.remove(); } },16);
    }

    /* memo (local) */
    const memo=document.getElementById('memo'); const saveMemo=document.getElementById('saveMemo'); const MEMO_KEY='memo_lo';
    try{ memo.value=localStorage.getItem(MEMO_KEY)||'' }catch{}
    saveMemo.addEventListener('click',()=>{ try{ localStorage.setItem(MEMO_KEY,memo.value); saveMemo.textContent='Saved ✓'; setTimeout(()=>saveMemo.textContent='Save',1000)}catch{} });

    /* since counter */
    let MEET_DATE_ISO='2025-03-21T06:09:00';
    function updateSince(){
      const el=document.getElementById('sinceCounter'); if(!el) return;
      const diff=Math.max(0, Date.now()-new Date(MEET_DATE_ISO).getTime());
      const d=Math.floor(diff/86400000);
      const h=Math.floor((diff%86400000)/3600000);
      const m=Math.floor((diff%3600000)/60000);
      const s=Math.floor((diff%60000)/1000);
      el.textContent=`Since we met: ${d}d ${h}h ${m}m ${s}s`;
    }
    updateSince(); setInterval(updateSince,1000);
  </script>

  <!-- I'm ready (مشترك) + Reset عبر JSONP لتفادي CORS -->
  <script>
  (function(){
    const COUPLE_ID = 'lojain_a23_ready';
    const API_URL   = 'https://script.google.com/macros/s/AKfycbwfrBBb4NLNHDX3M0_C80Jut1V6tblDaecBPWBgqSUqhr0E1EIopF86GkJszmyI2seBjw/exec';

    const readyBtn = document.getElementById('readyOnceBtn');
    const resetBtn = document.getElementById('resetReady');
    const stateEl  = document.getElementById('readyOnceState');
    if(!readyBtn || !stateEl) return;

    // JSONP helper (بدون CORS)
    function jsonp(url){
      return new Promise((resolve, reject)=>{
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        window[cb] = (data)=>{ resolve(data); cleanup(); };
        s.onerror = (e)=>{ reject(e); cleanup(); };
        function cleanup(){ try{ delete window[cb]; }catch{} s.remove(); }
        s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
        document.head.appendChild(s);
      });
    }

    function applyReady(ts){ readyBtn.disabled = true; readyBtn.textContent = '✔ Already marked'; stateEl.textContent = ts || 'Marked — synced across devices.'; }
    function clearReady(){ readyBtn.disabled = false; readyBtn.textContent = "I’m ready — tap once"; stateEl.textContent = ""; }

    async function fetchState(){
      try{
        const val = await jsonp(`${API_URL}?id=${encodeURIComponent(COUPLE_ID)}`);
        (val === 'ready') ? applyReady() : clearReady();
      }catch(e){ console.warn('fetchState JSONP failed', e); }
    }
    async function markReady(){
      try{
        const ts = new Date().toLocaleString();
        await jsonp(`${API_URL}?id=${encodeURIComponent(COUPLE_ID)}&state=ready`);
        applyReady('Marked on ' + ts + ' — synced.');
      }catch(e){ console.warn('markReady JSONP failed', e); }
    }
    async function resetReady(){
      try{
        await jsonp(`${API_URL}?id=${encodeURIComponent(COUPLE_ID)}&state=not_ready`);
        clearReady();
      }catch(e){ console.warn('resetReady JSONP failed', e); }
    }

    fetchState();
    readyBtn.addEventListener('click', ()=>{ if(!readyBtn.disabled) markReady(); });
    if (resetBtn) resetBtn.addEventListener('click', resetReady);
  })();
  </script>

  <!-- سكرول ناعم -->
  <script>
  (function(){
    const link = document.getElementById('downLink');
    const target = document.getElementById('readySection');
    if(!link || !target) return;

    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    link.addEventListener('click', (e) => {
      e.preventDefault();
      if ('scrollBehavior' in document.documentElement.style) {
        target.scrollIntoView({ behavior: prefersReduced ? 'auto' : 'smooth', block: 'start' });
        return;
      }
      const start = window.pageYOffset || document.documentElement.scrollTop;
      const end   = target.getBoundingClientRect().top + start;
      const dist  = end - start;
      const dur   = 500; let startTs;
      function step(ts){
        if(!startTs) startTs = ts;
        const t = Math.min(1, (ts - startTs) / dur);
        const ease = t<.5 ? 2*t*t : -1+(4-2*t)*t;
        window.scrollTo(0, start + dist*ease);
        if(t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });
  })();
  </script>

  <!-- دمية المزاج (مزامنة بسيطة مثل السابق) -->
  <script>
  (function(){
    const toy     = document.getElementById('moodToy');
    const figure  = document.getElementById('toyFigure');
    const labelEl = document.getElementById('toyLabel');

    const COUPLE_ID = 'lojain_a23';
    const API_URL   = 'https://script.google.com/macros/s/AKfycbwXfzLg1a_o8y2vEVEbXHeekIVhStkwajuYq8dHR6PM7yDVxMR13NyC9qdolaWklftUPw/exec';
    const KEY_LOCAL = 'lojain_mood';

    function apply(state){
      toy.classList.toggle('sad',   state === 'sad');
      toy.classList.toggle('happy', state !== 'sad');
      toy.setAttribute('aria-pressed', state === 'sad' ? 'true' : 'false');
      labelEl.textContent = state === 'sad' ? 'She is upset' : 'Click me';
    }

    async function fetchRemote(){
      try{
        const r = await fetch(API_URL + '?id=' + encodeURIComponent(COUPLE_ID), { cache:'no-store' });
        if(!r.ok) throw 0;
        const state = (await r.text()).trim() || 'happy';
        localStorage.setItem(KEY_LOCAL, state);
        apply(state);
      }catch{
        apply(localStorage.getItem(KEY_LOCAL) || 'happy');
      }
    }

    let busy=false;
    async function updateRemote(state){
      localStorage.setItem(KEY_LOCAL, state);
      if(busy) return; busy=true;
      try{
        const body = new URLSearchParams({ id: COUPLE_ID, state });
        await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' }, body });
      }finally{
        setTimeout(()=> busy=false, 400);
      }
    }

    fetchRemote();

    toy.addEventListener('click', ()=>{
      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduce){ figure.classList.remove('flip'); void figure.offsetWidth; figure.classList.add('flip'); }
      const current = toy.classList.contains('sad') ? 'sad' : 'happy';
      const next = current === 'happy' ? 'sad' : 'happy';
      apply(next);
      updateRemote(next);
    });
  })();
  </script>

  <!-- تحسينات موبايل إضافية (إصلاح 100vh + تقليل القلوب/النجوم) -->
  <script>
    (function () {
      const isMobile = /Mobi|Android/i.test(navigator.userAgent) || window.innerWidth < 520;

      function setVh() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      setVh(); window.addEventListener('resize', setVh);

      if (isMobile) {
        const starsWrap = document.getElementById('stars');
        if (starsWrap) {
          const many = starsWrap.querySelectorAll('.star');
          for (let i = 0; i < many.length; i++) { if (i % 2 === 0) many[i].remove(); }
        }
        const _setInterval = window.setInterval;
        let heartsTimerSet = false;
        window.setInterval = function (fn, ms) {
          if (!heartsTimerSet && ms === 700) { heartsTimerSet = true; return _setInterval(fn, 1200); }
          return _setInterval(fn, ms);
        };
      }

      window.addEventListener('touchstart', () => {}, { passive: true });
      window.addEventListener('touchmove', () => {}, { passive: true });
    })();
  </script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const card = document.getElementById('readyCard');
  if (!card) return;

  // لو المتصفح ما يدعم IO، نعطيه show مباشرة
  if (!('IntersectionObserver' in window)) {
    card.classList.add('show');
    return;
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        card.classList.add('show');
        io.disconnect();
      }
    });
  }, { threshold: 0.2 });

  io.observe(card);
});
</script>

</body>
</html>
